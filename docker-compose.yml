version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:14-alpine
    container_name: focusflow-db
    environment:
      POSTGRES_USER: focusflow
      POSTGRES_PASSWORD: focusflow_password
      POSTGRES_DB: focusflow
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/db/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U focusflow -d focusflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - focusflow-network
    restart: unless-stopped

  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: focusflow-backend
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: postgresql://focusflow:focusflow_password@db:5432/focusflow
      DB_POOL_SIZE: 10
      DB_SSL: "false"
      FRONTEND_URL: http://localhost:3000
      PYTHON_SERVICE_URL: http://python-service:8000
      # Security - These should be set via .env file in production
      JWT_SECRET: ${JWT_SECRET:-change-this-in-production}
      TOKEN_ENCRYPTION_KEY: ${TOKEN_ENCRYPTION_KEY:-}
      # Zoho OAuth - Set these in .env file
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID:-}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET:-}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI:-http://localhost:4000/auth/callback}
      ZOHO_ACCOUNTS_BASE_URL: ${ZOHO_ACCOUNTS_BASE_URL:-https://accounts.zoho.com}
      ZOHO_CLIQ_API_BASE_URL: ${ZOHO_CLIQ_API_BASE_URL:-https://cliq.zoho.com/api/v2}
      ZOHO_SCOPES: ${ZOHO_SCOPES:-ZohoCliq.bots.CREATE,ZohoCliq.bots.READ}
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-text}
    ports:
      - "4000:4000"
    volumes:
      - ./server:/app/server:ro
      - ./package.json:/app/package.json:ro
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - focusflow-network
    restart: unless-stopped

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: runtime
    container_name: focusflow-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    networks:
      - focusflow-network
    restart: unless-stopped

  # Python AI Service (Optional - if needed)
  python-service:
    build:
      context: ./python_service
      dockerfile: Dockerfile
    container_name: focusflow-python
    environment:
      PYTHONUNBUFFERED: 1
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:4000
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      - focusflow-network
    restart: unless-stopped
    profiles:
      - full

  # Adminer - Database Administration Tool (Optional)
  adminer:
    image: adminer:latest
    container_name: focusflow-adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
    depends_on:
      - db
    networks:
      - focusflow-network
    restart: unless-stopped
    profiles:
      - tools

volumes:
  postgres_data:
    driver: local

networks:
  focusflow-network:
    driver: bridge



